<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Live Code Streaming</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/codemirror.min.css">
    <!-- Multiple Editor Themes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/theme/one-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/theme/eclipse.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/theme/elegant.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/theme/material.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/theme/solarized.min.css">
    <style>
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --border-color: #404040;
            --accent-color: #007acc;
            --accent-hover: #005a9e;
            --success-color: #28a745;
            --success-hover: #218838;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #0d6efd;
            --accent-hover: #0b5ed7;
            --success-color: #198754;
            --success-hover: #157347;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .top-bar {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .session-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            flex: 1;
            min-width: 200px;
        }

        .controls-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .card {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .card-header {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 16px;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .list-group-item {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
            border-bottom: 1px solid var(--border-color);
            padding: 10px 16px;
            transition: background-color 0.2s ease;
        }

        .list-group-item:hover {
            background-color: var(--bg-secondary);
        }

        .list-group-item:last-child {
            border-bottom: none;
        }

        .CodeMirror {
            height: calc(100vh - 200px);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
        }

        #output-console {
            height: calc(100vh - 200px);
            overflow-y: auto;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .btn-custom {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
            border-radius: 6px;
            font-weight: 500;
            padding: 8px 16px;
            transition: all 0.2s ease;
        }

        .btn-custom:hover {
            background-color: var(--accent-hover);
            border-color: var(--accent-hover);
            color: white;
            transform: translateY(-1px);
        }

        .btn-success-custom {
            background-color: var(--success-color);
            border-color: var(--success-color);
            color: white;
            border-radius: 6px;
            font-weight: 600;
            padding: 10px 20px;
            transition: all 0.2s ease;
        }

        .btn-success-custom:hover {
            background-color: var(--success-hover);
            border-color: var(--success-hover);
            color: white;
            transform: translateY(-1px);
        }

        .form-select, .form-control {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .form-select:focus, .form-control:focus {
            background-color: var(--bg-tertiary);
            border-color: var(--accent-color);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 204, 0.25);
        }

        .form-label {
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 5px;
        }

        .main-container {
            height: calc(100vh - 80px);
            padding: 0;
        }

        .column-40 {
            width: 40%;
            padding: 15px;
            border-right: 1px solid var(--border-color);
        }

        .column-20 {
            width: 20%;
            padding: 15px;
        }

        .layout-container {
            display: flex;
            height: 100%;
        }

        .theme-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .theme-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .theme-slider {
            background-color: var(--accent-color);
        }

        input:checked + .theme-slider:before {
            transform: translateX(26px);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #28a745;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .font-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 4px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .font-btn:hover {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }

        .scroll-container {
            overflow-y: auto;
            height: 100%;
        }

        /* Custom scrollbar */
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .layout-container {
                flex-direction: column;
            }

            .column-40, .column-20 {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .CodeMirror, #output-console {
                height: 300px;
            }
        }
    </style>
</head>
<body data-theme="light">

<div class="top-bar">
    <button id="run-btn" class="btn btn-success-custom">
        â–¶ Run Code
    </button>

    <div class="controls-group">
        <label class="form-label mb-0">Theme:</label>
        <label class="theme-toggle">
            <input type="checkbox" id="theme-toggle">
            <span class="theme-slider"></span>
        </label>

        <label for="editor-theme-select" class="form-label mb-0">Editor:</label>
        <select id="editor-theme-select" class="form-select" style="width: auto;">
            <option value="one-dark">One Dark</option>
            <option value="material-darker">Material Darker</option>
            <option value="dracula">Dracula</option>
            <option value="monokai">Monokai</option>
            <option value="eclipse">Eclipse</option>
            <option value="elegant">Elegant</option>
            <option value="material">Material</option>
            <option value="solarized light">Solarized Light</option>
        </select>

        <label for="lang-select" class="form-label mb-0">Language:</label>
        <select id="lang-select" class="form-select" style="width: auto;">
            <option value="python">Python</option>
            <option value="javascript">JavaScript</option>
        </select>
    </div>

    <h1 class="session-title">
        <span class="status-indicator"></span>
        Live Code Session: <span id="session-id"></span>
    </h1>
</div>

<div class="main-container">
    <div class="layout-container">
        <!-- Code Editor - 40% -->
        <div class="column-40">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Code Editor</span>
                    <div class="font-size-control">
                        <button class="font-btn" id="font-decrease">A-</button>
                        <span id="font-size-display" style="font-size: 12px; color: var(--text-secondary);">14</span>
                        <button class="font-btn" id="font-increase">A+</button>
                    </div>
                </div>
                <div class="card-body p-0 h-100">
                    <div id="coding-box" style="height: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- Output Console - 40% -->
        <div class="column-40">
            <div class="card h-100">
                <div class="card-header">
                    <div class="output-header">
                        <span>Output Console</span>
                        <small style="color: var(--text-secondary);">Ready for execution</small>
                    </div>
                </div>
                <div class="card-body p-0 h-100">
                    <div class="scroll-container">
                        <pre id="output-console">Waiting for code execution...</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Online Users - 20% -->
        <div class="column-20">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Online Users</span>
                    <span id="user-count" class="badge" style="background-color: var(--accent-color);">0</span>
                </div>
                <div class="scroll-container">
                    <ul id="users-list" class="list-group list-group-flush"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/mode/go/go.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/mode/clike/clike.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/addon/edit/matchbrackets.min.js"></script>

<script>
    class EditorBox {
        constructor() {
            this.fontSize = 14;
            this.editor = CodeMirror(document.getElementById('coding-box'), {
                value: "",
                mode: "javascript",
                theme: "elegant",
                lineNumbers: true,
                indentUnit: 4,
                indentWithTabs: true,
                extraKeys: {"Tab": "indentMore", "Shift-Tab": "indentLess"},
                autoCloseBrackets: true,
                matchBrackets: true
            });
            this.isUpdating = false;
            this.syncedContent = "";
            this.language = "javascript";
            this.updateFontSize();
        }

        setLanguage(lang) {
            this.language = lang;
            this.editor.setOption('mode', lang);
        }

        setTheme(theme) {
            this.editor.setOption('theme', theme);
        }

        setContent(content) {
            this.editor.setValue(content);
            this.syncedContent = content;
        }

        updateFontSize() {
            const wrapper = this.editor.getWrapperElement();
            wrapper.style.fontSize = this.fontSize + 'px';
            this.editor.refresh();
            document.getElementById('font-size-display').textContent = this.fontSize;
        }

        increaseFontSize() {
            if (this.fontSize < 24) {
                this.fontSize++;
                this.updateFontSize();
            }
        }

        decreaseFontSize() {
            if (this.fontSize > 8) {
                this.fontSize--;
                this.updateFontSize();
            }
        }

        applyPatch(patch) {
            this.isUpdating = true;
            const doc = this.editor.getDoc();
            let startPos = doc.posFromIndex(patch.start_pos);
            let endPos = patch.end_pos !== undefined ? doc.posFromIndex(patch.end_pos) : startPos;

            if (patch.op === 'add') {
                doc.replaceRange(patch.content, startPos, startPos);
            } else if (patch.op === 'remove') {
                doc.replaceRange('', startPos, endPos);
            } else if (patch.op === 'replace') {
                doc.replaceRange(patch.content, startPos, endPos);
            }
            this.syncedContent = this.editor.getValue();
            this.isUpdating = false;
        }
    }

    function generatePatch(oldText, newText) {
        let start = 0;
        while (start < oldText.length && start < newText.length && oldText[start] === newText[start]) {
            start++;
        }
        let oldEnd = oldText.length;
        let newEnd = newText.length;
        while (oldEnd > start && newEnd > start && oldText[oldEnd - 1] === newText[newEnd - 1]) {
            oldEnd--;
            newEnd--;
        }

        const deletedText = oldText.slice(start, oldEnd);
        const insertedText = newText.slice(start, newEnd);

        if (deletedText.length === 0 && insertedText.length === 0) {
            return null;
        }

        if (deletedText.length === 0) {
            return {op: 'add', start_pos: start, content: insertedText};
        } else if (insertedText.length === 0) {
            return {op: 'remove', start_pos: start, end_pos: oldEnd};
        } else {
            return {op: 'replace', start_pos: start, end_pos: oldEnd, content: insertedText};
        }
    }

    function throttle(func, delay) {
        let timeout;
        return (...args) => {
            if (timeout) return;
            timeout = setTimeout(() => {
                func(...args);
                timeout = null;
            }, delay);
        };
    }

    function getHueForUser(username) {
        let hash = 0;
        for (let i = 0; i < username.length; i++) {
            hash = username.charCodeAt(i) + ((hash << 5) - hash);
        }
        return hash % 360;
    }

    // Theme Management
    function toggleTheme() {
        const body = document.body;
        const isDark = body.getAttribute('data-theme') === 'dark';
        body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    document.getElementById('theme-toggle').checked = savedTheme === 'light';

    let box = new EditorBox();
    let path = document.location.pathname.split('/');
    let sessionID = path[path.length - 1];
    let username = ""
    document.getElementById('session-id').textContent = sessionID;
    let currentVersion = 0;
    let users = new Map();

    function updateUsersList() {
        const list = document.getElementById('users-list');
        const userCount = document.getElementById('user-count');

        list.innerHTML = '';
        userCount.textContent = users.size;

        users.forEach((userData, userName) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex align-items-center';
            li.innerHTML = `
                <div class="status-indicator" style="background-color: hsl(${userData.hue}, 70%, 50%); position: static; margin-right: 8px;"></div>
                <span style="color: hsl(${userData.hue}, 70%, 60%); font-weight: 500;">${userName}</span>
            `;
            list.appendChild(li);
        });
    }

    // let ws = new WebSocket(`ws://localhost:8000/ws?session_id=${sessionID}`);
    let ws = new WebSocket(`wss://interview.bigdev.uz/ws?session_id=${sessionID}`);
    ws.addEventListener('close', () => {
        document.body.innerHTML = ""
        alert("Connection closed, please refresh page")
        document.location.reload()
    })

    ws.addEventListener('message', ev => {
        let msg = JSON.parse(ev.data);
        if (!msg || !msg.type) return;
        const t = msg.type;
        const d = msg.data || {};
        switch (t) {
            case 'session_init':
                box.setContent(d.current_code || '');
                let patches = d.patches || [];
                username = d.username
                for (let i = 0; i < patches.length; i++) {
                    box.applyPatch(patches[i]);
                }
                currentVersion = d.version || 0;
                (d.users || []).forEach(u => {
                    const hue = getHueForUser(u.username);
                    users.set(u.username, {hue: hue, selectionMarker: null, cursorMarker: null});
                });
                updateUsersList();
                if (d.lang) {
                    box.setLanguage(d.lang);
                    document.getElementById('lang-select').value = d.lang;
                }
                break;

            case 'code_patch':
                box.applyPatch({
                    op: d.op,
                    start_pos: d.start_pos,
                    end_pos: d.end_pos,
                    content: d.content
                });
                currentVersion = d.version;
                break;

            case 'user_joined':
                const hue = getHueForUser(d.username);
                users.set(d.username, {hue: hue, selectionMarker: null, cursorMarker: null});
                updateUsersList();
                break;

            case 'user_left':
                const leavingUser = users.get(d.username);
                if (leavingUser) {
                    if (leavingUser.selectionMarker) leavingUser.selectionMarker.clear();
                    if (leavingUser.cursorMarker) leavingUser.cursorMarker.clear();
                }
                users.delete(d.username);
                updateUsersList();
                break;

            case 'cursor_select':
                const userSel = users.get(d.username);
                if (!userSel || d.username === username) return;
                if (userSel.selectionMarker) {
                    userSel.selectionMarker.clear();
                    userSel.selectionMarker = null;
                }
                if (userSel.cursorMarker) {
                    userSel.cursorMarker.clear();
                    userSel.cursorMarker = null;
                }

                const doc = box.editor.getDoc();
                const anchorPos = doc.posFromIndex(d.end_pos);
                const headPos = doc.posFromIndex(d.start_pos);
                let from = (d.end_pos < d.start_pos) ? anchorPos : headPos;
                let to = (d.end_pos < d.start_pos) ? headPos : anchorPos;
                const cursorPos = headPos;

                const cursorColor = `hsl(${userSel.hue}, 70%, 60%)`;
                const selectionBg = `hsla(${userSel.hue}, 70%, 50%, 0.2)`;

                if (d.end_pos !== d.start_pos) {
                    userSel.selectionMarker = doc.markText(from, to, {css: `background-color: ${selectionBg}`});
                }

                let widget = document.createElement('span');
                widget.style.borderLeft = `2px solid ${cursorColor}`;
                widget.style.height = '100%';
                widget.style.marginLeft = '-1px';
                userSel.cursorMarker = doc.setBookmark(cursorPos, {widget: widget, insertLeft: true});
                break;

            case 'edit_lang':
                box.setLanguage(d.lang);
                document.getElementById('lang-select').value = d.lang;
                break;

            case 'code_res':
                displayOutput(d);
                break;

            case 'error':
                displayError(d.message || 'An error occurred');
                break;
        }
    });

    function displayOutput(data) {
        const consoleEl = document.getElementById('output-console');
        let output = '';

        if (data.std_out) {
            output += `ðŸ“¤ STDOUT:\n${data.std_out}\n\n`;
        }
        if (data.std_err) {
            output += `ðŸš¨ STDERR:\n${data.std_err}\n\n`;
        }
        if (data.exit_code !== undefined) {
            output += `ðŸ Exit Code: ${data.exit_code}\n`;
        }
        if (data.duration) {
            output += `â±ï¸ Duration: ${data.duration}\n`;
        }
        if (data.error) {
            output += `âŒ Error: ${data.error}\n`;
        }

        consoleEl.textContent = output || 'âœ… No output (execution completed successfully)';
        consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    function displayError(message) {
        const consoleEl = document.getElementById('output-console');
        consoleEl.textContent = `âŒ Error: ${message}`;
        consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    // Event Listeners
    let debounceTimer = null;
    box.editor.on('change', () => {
        if (box.isUpdating) return;
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const newContent = box.editor.getValue();
            const patch = generatePatch(box.syncedContent, newContent);
            if (patch && ws.readyState === WebSocket.OPEN) {
                patch.version = currentVersion + 1;
                ws.send(JSON.stringify({
                    type: 'code_patch',
                    data: patch
                }));
                box.syncedContent = newContent;
                currentVersion = patch.version;
            }
        }, 100);
    });

    const sendCursor = throttle(() => {
        const doc = box.editor.getDoc();
        const selections = doc.listSelections();
        if (selections.length === 0) return;
        const head = doc.indexFromPos(selections[0].head);
        const anchor = doc.indexFromPos(selections[0].anchor);
        ws.send(JSON.stringify({
            type: 'cursor_select',
            data: {end_pos: anchor, start_pos: head}
        }));
    }, 200);

    box.editor.on('cursorActivity', sendCursor);

    // Control Event Listeners
    document.getElementById('theme-toggle').addEventListener('change', toggleTheme);

    document.getElementById('editor-theme-select').addEventListener('change', (e) => {
        box.setTheme(e.target.value);
        localStorage.setItem('editorTheme', e.target.value);
    });

    document.getElementById('lang-select').addEventListener('change', (e) => {
        ws.send(JSON.stringify({
            type: 'edit_lang',
            data: {lang: e.target.value}
        }));
        box.setLanguage(e.target.value);
    });

    document.getElementById('run-btn').addEventListener('click', () => {
        const consoleEl = document.getElementById('output-console');
        consoleEl.textContent = 'ðŸ”„ Executing code...';

        ws.send(JSON.stringify({
            type: 'code_run'
        }));
    });

    document.getElementById('font-increase').addEventListener('click', () => {
        box.increaseFontSize();
    });

    document.getElementById('font-decrease').addEventListener('click', () => {
        box.decreaseFontSize();
    });

    // Load saved editor theme
    const savedEditorTheme = localStorage.getItem('editorTheme') || 'elegant';
    document.getElementById('editor-theme-select').value = savedEditorTheme;
    box.setTheme(savedEditorTheme);

    // Initialize user list
    updateUsersList();
</script>
</body>
</html>