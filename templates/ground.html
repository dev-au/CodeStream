<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Live Code Streaming</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/theme/monokai.min.css">
</head>
<body class="bg-dark text-light">

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1>Live Code Streaming - Session: <span id="session-id"></span></h1>
        </div>
    </div>
    <div class="row">
        <div class="col-3">
            <div class="card bg-secondary text-light">
                <div class="card-header">Online Users</div>
                <ul id="users-list" class="list-group list-group-flush"></ul>
            </div>
            <div class="mt-3">
                <label for="lang-select" class="form-label">Language:</label>
                <select id="lang-select" class="form-select">
                    <option value="javascript">JavaScript</option>
                    <option value="python">Python</option>
                    <!-- Add more language options as needed -->
                </select>
            </div>
            <button id="refresh-btn" class="btn btn-primary mt-3">Refresh</button>
        </div>
        <div class="col-9">
            <div id="coding-box"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/mode/python/python.min.js"></script>
<!-- Add more mode scripts for other languages as needed -->

<script>
    class EditorBox {
        constructor() {
            this.editor = CodeMirror(document.getElementById('coding-box'), {
                value: "",
                mode: "javascript",
                theme: "monokai",
                lineNumbers: true,
                indentUnit: 4,
                indentWithTabs: true,
                extraKeys: { "Tab": "indentMore", "Shift-Tab": "indentLess" }
            });
            this.isUpdating = false;
            this.syncedContent = "";
            this.language = "javascript";
        }

        setLanguage(lang) {
            this.language = lang;
            this.editor.setOption('mode', lang);
        }

        setContent(content) {
            this.editor.setValue(content);
            this.syncedContent = content;
        }

        applyPatch(patch) {
            this.isUpdating = true;
            const doc = this.editor.getDoc();
            let startPos = doc.posFromIndex(patch.start_pos);
            let endPos = patch.end_pos !== undefined ? doc.posFromIndex(patch.end_pos) : startPos;

            if (patch.op === 'add') {
                doc.replaceRange(patch.content, startPos, startPos);
            } else if (patch.op === 'remove') {
                doc.replaceRange('', startPos, endPos);
            } else if (patch.op === 'replace') {
                doc.replaceRange(patch.content, startPos, endPos);
            }
            this.syncedContent = this.editor.getValue();
            this.isUpdating = false;
        }
    }

    function generatePatch(oldText, newText) {
        let start = 0;
        while (start < oldText.length && start < newText.length && oldText[start] === newText[start]) {
            start++;
        }
        let oldEnd = oldText.length;
        let newEnd = newText.length;
        while (oldEnd > start && newEnd > start && oldText[oldEnd - 1] === newText[newEnd - 1]) {
            oldEnd--;
            newEnd--;
        }

        const deletedText = oldText.slice(start, oldEnd);
        const insertedText = newText.slice(start, newEnd);

        if (deletedText.length === 0 && insertedText.length === 0) {
            return null;
        }

        if (deletedText.length === 0) {
            return { op: 'add', start_pos: start, content: insertedText };
        } else if (insertedText.length === 0) {
            return { op: 'remove', start_pos: start, end_pos: oldEnd };
        } else {
            return { op: 'replace', start_pos: start, end_pos: oldEnd, content: insertedText };
        }
    }

    function throttle(func, delay) {
        let timeout;
        return (...args) => {
            if (timeout) return;
            timeout = setTimeout(() => {
                func(...args);
                timeout = null;
            }, delay);
        };
    }

    let box = new EditorBox();
    let path = document.location.pathname.split('/');
    let sessionID = path[path.length - 1];
    document.getElementById('session-id').textContent = sessionID;
    let username = "User" + Math.random().toString().slice(2, 8);
    let currentVersion = 0;
    let users = [];

    function updateUsersList() {
        document.getElementById('users-list').innerHTML = users.map(u =>
            `<li class="list-group-item bg-secondary text-light">${u.username} ${u.cursor !== undefined ? `(cursor: ${u.cursor})` : ''}</li>`
        ).join('');
    }

    let ws = new WebSocket(`ws://localhost:8000/ws?session_id=${sessionID}&username=${username}`);

    ws.addEventListener('message', ev => {
        let msg = JSON.parse(ev.data);
        if (!msg || !msg.type) return;
        const t = msg.type;
        const d = msg.data || {};
        switch (t) {
            case 'session_init':
                box.setContent(d.current_code || '');
                let patches = d.patches || [];
                for (let i = 0; i < patches.length; i++) {
                    box.applyPatch(patches[i]);
                }
                currentVersion = d.version || 0;
                users = d.users || [];
                updateUsersList();
                if (d.lang) {
                    box.setLanguage(d.lang);
                    document.getElementById('lang-select').value = d.lang;
                }
                break;

            case 'code_patch':
                box.applyPatch({
                    op: d.op,
                    start_pos: d.start_pos,
                    end_pos: d.end_pos,
                    content: d.content
                });
                currentVersion = d.version;
                break;

            case 'user_joined':
                users.push({ username: d.username });
                updateUsersList();
                break;

            case 'user_left':
                users = users.filter(u => u.username !== d.username);
                updateUsersList();
                break;

            case 'cursor_position':
                const user = users.find(u => u.username === d.username);
                if (user) {
                    user.cursor = d.position;
                    updateUsersList();
                }
                break;

            case 'lang_change':
                box.setLanguage(d.lang);
                document.getElementById('lang-select').value = d.lang;
                break;

            case 'error':
                alert(d.message);
                break;
        }
        console.log(currentVersion);
    });

    let debounceTimer = null;
    box.editor.on('change', () => {
        if (box.isUpdating) return;
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const newContent = box.editor.getValue();
            const patch = generatePatch(box.syncedContent, newContent);
            if (patch && ws.readyState === WebSocket.OPEN) {
                patch.version = currentVersion + 1;
                ws.send(JSON.stringify({
                    type: 'code_patch',
                    data: patch
                }));
                box.syncedContent = newContent;
                currentVersion = patch.version;
                console.log('Sent patch:', patch);
            }
        }, 100);
    });

    const sendCursor = throttle(() => {
        const doc = box.editor.getDoc();
        const pos = doc.indexFromPos(doc.getCursor());
        ws.send(JSON.stringify({
            type: 'cursor_position',
            data: { position: pos }
        }));
    }, 200);

    box.editor.on('cursorActivity', sendCursor);

    document.getElementById('lang-select').addEventListener('change', (e) => {
        ws.send(JSON.stringify({
            type: 'edit_lang',
            data: { lang: e.target.value }
        }));
    });

    document.getElementById('refresh-btn').addEventListener('click', () => {
        ws.send(JSON.stringify({
            type: 'refresh'
        }));
    });

</script>

</body>
</html>